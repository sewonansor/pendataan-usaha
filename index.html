<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pendataan Usaha Anggota</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="icon" type="image/webp" href="Ansor_emblem.webp">
  <style>
    /* Gaya tetap sama seperti sebelumnya */
    .header {
      background-color: #2C3E50;
      color: white;
      padding: 30px;
      text-align: center;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .header img {
      max-height: 100px;
      margin-bottom: 10px;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
    }

    .header img:hover {
      transform: scale(1.15);
      filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.3)) brightness(1.1);
    }

    .header img:active {
      transform: scale(1.1);
      transition: all 0.1s ease;
    }

    .header h1 {
      transition: all 0.3s ease;
    }

    .header:hover h1 {
      letter-spacing: 0.5px;
    }

    .card {
      margin: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    #map {
      height: 400px;
      width: 100%;
      border-radius: 10px;
      margin-top: 20px;
    }

    .table-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      margin-top: 20px;
      border-radius: 8px;
    }

    #thankYouMessage {
      display: none;
      font-size: 24px;
      color: #2ecc71;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #showMapButton, #toggleTableButton {
      margin-top: 20px;
      display: block;
      width: 100%;
      transition: all 0.3s ease;
    }

    #showMapButton:hover, #toggleTableButton:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    #mapSebaranContainer {
      margin-top: 20px;
    }

    #addBusinessButton {
      margin-top: 20px;
      margin-bottom: 20px;
      display: block;
      width: 100%;
      background-color: #28a745;
      color: white;
      border-radius: 5px;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease-in-out;
      position: relative;
      overflow: hidden;
    }

    #addBusinessButton:hover {
      background-color: #218838;
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    #addBusinessButton:active {
      transform: scale(0.98);
    }

    #addBusinessButton::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    #addBusinessButton:active::after {
      width: 300px;
      height: 300px;
    }
    
    .dataTables_wrapper .dataTables_filter {
      float: none;
      text-align: left;
      margin-bottom: 10px;
    }
    
    .dataTables_wrapper .dataTables_filter input {
      margin-left: 0;
      width: 300px;
      transition: all 0.3s ease;
      border-radius: 20px;
      padding: 8px 15px;
    }
    
    .dataTables_wrapper .dataTables_filter input:focus {
      width: 350px;
      box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.25);
    }
    
    .dataTables_wrapper .dataTables_length {
      float: none;
      margin-bottom: 10px;
    }

    #usahanTable tbody tr {
      transition: all 0.2s ease;
    }

    #usahanTable tbody tr:hover {
      background-color: #f8f9fa;
      transform: scale(1.01);
    }

    /* Gaya untuk kontrol pencarian manual - dipindahkan ke kanan atas */
    .custom-search-container {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }
    
    .custom-search-input {
      width: 300px;
      padding: 8px 15px;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 14px;
    }

    /* Gaya untuk notifikasi */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 9999;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background-color: #28a745;
    }

    .notification.error {
      background-color: #dc3545;
    }

    .notification.info {
      background-color: #17a2b8;
    }

    @media (max-width: 768px) {
      .header img {
        max-height: 80px;
      }
      
      .header img:hover {
        transform: scale(1.1);
      }
      
      .dataTables_wrapper .dataTables_filter input {
        width: 100%;
      }
      
      .dataTables_wrapper .dataTables_filter input:focus {
        width: 100%;
      }
      
      .custom-search-input {
        width: 200px;
      }
    }
  </style>
</head>
<body>
 <div class="container-fluid">
    <div class="header">
      <img src="Ansor_emblem.webp" alt="Logo GP Ansor" class="logo-interactive">
      <h1>Pendataan Usaha Anggota</h1>
      <p>Manjemen data usaha yang dimiliki oleh anggota kami</p>
    </div>
  </div>

  <div class="container mt-4">
    <div class="row mb-4">
      <div class="col-6">
        <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#tutorialModal">
          ðŸ“˜ Tutorial
        </button>
      </div>
      <div class="col-6">
        <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#kontakAdminModal">
          ðŸ“ž Kontak Admin
        </button>
      </div>
    </div>

    <!-- Tombol untuk menambahkan usaha -->
    <button id="addBusinessButton" onclick="toggleFormVisibility()">Tambahkan Usaha</button>

    <!-- Form Input Usaha (disembunyikan awalnya) -->
    <div class="row" id="addBusinessForm" style="display: none;">
      <div class="col-md-6 offset-md-3">
        <div class="card">
          <div class="card-header">
            <h4>Tambah Usaha Anggota</h4>
          </div>
          <div class="card-body">
            <form id="usahanForm">
              <div class="mb-3">
                <label for="namaPemilik" class="form-label">Nama Pemilik</label>
                <input type="text" class="form-control" id="namaPemilik" placeholder="Contoh: Ulinnuha" required>
              </div>
              <div class="mb-3">
                <label for="namaUsaha" class="form-label">Nama Usaha</label>
                <input type="text" class="form-control" id="namaUsaha" placeholder="Contoh: Okebeb Telur Asin" required>
              </div>
              <div class="mb-3">
                <label for="jenisUsaha" class="form-label">Jenis Usaha</label>
                <input type="text" class="form-control" id="jenisUsaha" placeholder="Contoh: Makanan/Minuman/Fasion/dll" required>
              </div>
                <div class="mb-3">
                <label for="nomorHp" class="form-label">Nomor HP</label>
                <input type="tel" class="form-control" id="nomorHp" placeholder="Contoh: 0838........" required>
              </div>

              <!-- Peta untuk input lokasi usaha -->
              <div class="mb-3">
                <label for="lokasiMap" class="form-label">Pilih Lokasi di Peta</label>
                <div id="map"></div>
              </div>
              <div class="mb-3">
                <label for="lokasiUsaha" class="form-label">Lokasi Usaha</label>
                <input type="text" class="form-control" id="lokasiUsaha" placeholder="Cukup Klik Dapatkan Lokasi Saya" required>
              </div>
              <button type="button" class="btn btn-secondary" onclick="getLocation()">Dapatkan Lokasi Saya</button>
              <button type="submit" class="btn btn-primary">Bismillah Cuan</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Pesan Terima Kasih -->
    <div id="thankYouMessage">Terima Kasih Sahabat!</div>

    <!-- Tombol untuk menampilkan Peta Sebaran -->
    <button id="showMapButton" class="btn btn-primary" onclick="toggleMapSebaran()">Tampilkan Peta Sebaran</button>

    <!-- Tombol untuk menampilkan/sembunyikan tabel -->
    <button id="toggleTableButton" class="btn btn-secondary" onclick="toggleTable()">Sembunyikan Tabel</button>

    <!-- Peta Sebaran Usaha (sembunyi pada awalnya) -->
    <div class="card mt-5" id="mapSebaranContainer" style="display: none;">
      <div class="card-header">
        <h4>Peta Sebaran Usaha Anggota</h4>
      </div>
      <div class="card-body">
        <div id="mapSebaran" style="height: 500px; width: 100%; border-radius: 10px; position: relative;">
            <!-- Kontrol pencarian manual -->
            <div class="custom-search-container">
                <input type="text" class="custom-search-input" id="mapSearchInput" placeholder="Cari: usaha, pemilik, jenis...">
            </div>
        </div>
      </div>
    </div>

    <!-- Tabel Daftar Usaha Anggota -->
    <div class="table-container" id="tableContainer">
      <table class="table table-bordered table-striped" id="usahanTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Nama Pemilik</th>
            <th>Nama Usaha</th>
            <th>Jenis Usaha</th>
            <th>Lokasi Usaha</th>
            <th>Nomor HP</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data akan dimasukkan di sini -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal Tutorial -->
  <div class="modal fade" id="tutorialModal" tabindex="-1" aria-labelledby="tutorialLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title" id="tutorialLabel">Tutorial Pengisian Form Usaha</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <ol>
            <li><b>Isi Nama Pemilik</b> dengan nama lengkap anggota.</li>
            <li><b>Isi Nama Usaha</b> sesuai usaha yang dijalankan.</li>
            <li><b>Pilih Jenis Usaha</b> (contoh: makanan, minuman, fashion, jasa, dll).</li>
            <li><b>Isi Lokasi Usaha</b>:
              <ul>
                <li>Klik peta untuk memilih lokasi, atau</li>
                <li>Gunakan tombol <i>"Dapatkan Lokasi Saya"</i> agar otomatis.</li>
              </ul>
            </li>
            <li><b>Isi Nomor HP</b> yang aktif agar bisa dihubungi.</li>
            <li>Setelah lengkap, klik tombol <b>"Bismillah Cuan"</b> untuk menyimpan data.</li>
            <li>Data akan muncul otomatis di tabel dan peta sebaran.</li>
          </ol>
          <p class="text-success"><b>Tips:</b> Pastikan koneksi internet aktif agar data tersimpan di sistem.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Kontak Admin -->
  <div class="modal fade" id="kontakAdminModal" tabindex="-1" aria-labelledby="kontakAdminLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="kontakAdminLabel">Kontak Admin via WhatsApp</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <form id="kontakAdminForm">
            <div class="mb-3">
              <label class="form-label">Nama</label>
              <input type="text" id="adminNama" class="form-control" placeholder="Nama Anda" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Alamat</label>
              <input type="text" id="adminAlamat" class="form-control" placeholder="Alamat Lengkap" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Kendala</label>
              <textarea id="adminKendala" class="form-control" rows="3" placeholder="Jelaskan kendala yang dialami..." required></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-success" onclick="kirimWAAdmin()">Kirim ke Admin</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifikasi -->
  <div id="notification" class="notification"></div>

  <!-- JavaScript -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <!-- Tambahkan EmailJS SDK -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <script>
    // Inisialisasi EmailJS (Ganti dengan USER_ID kamu)
    emailjs.init("YOUR_USER_ID");

    // Variabel global
    let businesses = [];
    let map;
    let marker;
    let mapSebaran = null;
    let markersGroup;
    let dataTable;
    let allMarkers = []; // Menyimpan semua marker untuk pencarian
    let lastDataLength = 0; // Menyimpan panjang data sebelumnya untuk deteksi perubahan

    // Inisialisasi peta dan data saat halaman dimuat
    window.onload = function() {
      initMap();
      fetchData();
    };

    function initMap() {
      // Inisialisasi peta dengan koordinat pusat Indonesia
      map = L.map('map').setView([-6.200000, 106.816666], 12);

      // Tile layer OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Membuat marker yang dapat digeser
      marker = L.marker([-6.200000, 106.816666], { draggable: true }).addTo(map);

      marker.on('dragend', function(event) {
        const latLng = marker.getLatLng();
        document.getElementById('lokasiUsaha').value = `Latitude: ${latLng.lat}, Longitude: ${latLng.lng}`;
      });

      map.on('click', function(e) {
        const latLng = e.latlng;
        marker.setLatLng(latLng);
        document.getElementById('lokasiUsaha').value = `Latitude: ${latLng.lat}, Longitude: ${latLng.lng}`;
      });

      // Memperbarui ukuran peta
      map.invalidateSize();
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          // Set peta ke lokasi pengguna
          map.setView([lat, lng], 15);
          marker.setLatLng([lat, lng]);
          document.getElementById('lokasiUsaha').value = `Latitude: ${lat}, Longitude: ${lng}`;
          marker.bindPopup("Lokasi Anda").openPopup();
          map.invalidateSize();
        }, function() {
          alert("Gagal mendapatkan lokasi Anda. Pastikan izin lokasi diaktifkan.");
        });
      } else {
        alert("Geolocation tidak didukung oleh browser ini.");
      }
    }

    // Ambil data dari Google Sheets
    function fetchData() {
      fetch('https://script.google.com/macros/s/AKfycbydjbuQJ9MA_ZxRQALkrvE-eEBgoSx4Dr5B-KHMAPSk0DXwQlUSbtGDiBH_Q-tr5WS5bw/exec')
        .then(response => response.json())
        .then(data => {
          // Deteksi apakah ada data baru
          if (data.length > lastDataLength) {
            const newEntriesCount = data.length - lastDataLength;
            showNotification(`Data baru masuk! ${newEntriesCount} entri baru ditambahkan.`, 'info');
          }
          
          // Update lastDataLength
          lastDataLength = data.length;
          
          businesses = data;
          renderBusinesses(businesses);
        })
        .catch(error => console.error('Error fetching  ', error));
    }

    // Render Tabel Usaha dengan DataTables
    function renderBusinesses(data) {
      const tableBody = document.querySelector("#usahanTable tbody");
      tableBody.innerHTML = "";

      data.forEach((row, index) => {
        const rowHtml = `
          <tr>
            <td>${index + 1}</td>
            <td>${row.namaPemilik}</td>
            <td>${row.namaUsaha}</td>
            <td>${row.jenisUsaha}</td>
            <td>${row.lokasiUsaha}</td>
            <td>${row.nomorHp}</td>
          </tr>
        `;
        tableBody.innerHTML += rowHtml;
      });

      // Inisialisasi atau refresh DataTable
      if ($.fn.DataTable.isDataTable('#usahanTable')) {
        // Simpan status sorting sebelum menghancurkan
        const currentOrder = dataTable.order();
        const currentPage = dataTable.page();
        const currentSearch = dataTable.search();
        const currentLength = dataTable.page.len();
        
        // Simpan ke localStorage
        localStorage.setItem('dataTableOrder', JSON.stringify(currentOrder));
        localStorage.setItem('dataTablePage', currentPage);
        localStorage.setItem('dataTableSearch', currentSearch);
        localStorage.setItem('dataTableLength', currentLength);

        $('#usahanTable').DataTable().destroy();
      }

      // Ambil status sorting dari localStorage jika ada
      const savedOrder = JSON.parse(localStorage.getItem('dataTableOrder')) || [[0, 'asc']]; // Default ke kolom pertama, ASC
      const savedPage = localStorage.getItem('dataTablePage') || 0;
      const savedSearch = localStorage.getItem('dataTableSearch') || '';
      const savedLength = localStorage.getItem('dataTableLength') || 10;

      dataTable = $('#usahanTable').DataTable({
        "pageLength": parseInt(savedLength),
        "lengthMenu": [5, 10, 25, 50],
        "order": savedOrder, // Gunakan sorting yang disimpan
        "search": {
          "search": savedSearch
        },
        "language": {
          "search": "Cari:",
          "lengthMenu": "Tampilkan _MENU_ data per halaman",
          "zeroRecords": "Tidak ada data yang ditemukan",
          "info": "Menampilkan halaman _PAGE_ dari _PAGES_",
          "infoEmpty": "Tidak ada data tersedia",
          "infoFiltered": "(disaring dari _MAX_ total data)"
        }
      });

      // Setelah inisialisasi, pindah ke halaman yang disimpan
      dataTable.page(parseInt(savedPage)).draw('page');

      // Kita tidak perlu memanggil setupColumnFilters() karena filter dihapus
    }

    // Fungsi untuk menampilkan notifikasi
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification ' + type; // Tambahkan kelas tipe notifikasi
      notification.classList.add('show');

      setTimeout(() => {
        notification.classList.remove('show');
      }, 5000); // Notifikasi hilang setelah 5 detik
    }

    // Kirim WA Admin
    function kirimWAAdmin() {
      const nama = document.getElementById("adminNama").value;
      const alamat = document.getElementById("adminAlamat").value;
      const kendala = document.getElementById("adminKendala").value;

      if (!nama || !alamat || !kendala) {
        alert("Harap isi semua field sebelum mengirim pesan!");
        return;
      }

      // Nomor admin (format internasional tanpa +)
      const adminNumber = "6283866675521";
      const pesan = `Nama: ${encodeURIComponent(nama)}%0AAlamat: ${encodeURIComponent(alamat)}%0AKendala: ${encodeURIComponent(kendala)}`;
      const url = `https://wa.me/${adminNumber}?text=${pesan}`;

      window.open(url, "_blank");
    }

    // Submit form
    document.getElementById("usahanForm").addEventListener("submit", function(event) {
      event.preventDefault();

      const namaPemilik = document.getElementById("namaPemilik").value;
      const namaUsaha = document.getElementById("namaUsaha").value;
      const jenisUsaha = document.getElementById("jenisUsaha").value;
      const lokasiUsaha = document.getElementById("lokasiUsaha").value;
      const nomorHp = document.getElementById("nomorHp").value;

      // Validasi nomor HP
      if (!/^[0-9\-\+\s\(\)]+$/.test(nomorHp)) {
        alert("Nomor HP hanya boleh berisi angka dan simbol (+, -, spasi, kurung)");
        return;
      }

      fetch('https://script.google.com/macros/s/AKfycbydjbuQJ9MA_ZxRQALkrvE-eEBgoSx4Dr5B-KHMAPSk0DXwQlUSbtGDiBH_Q-tr5WS5bw/exec', {
        method: 'POST',
        body: new URLSearchParams({
          'namaPemilik': namaPemilik,
          'namaUsaha': namaUsaha,
          'jenisUsaha': jenisUsaha,
          'lokasiUsaha': lokasiUsaha,
          'nomorHp': nomorHp,
          'lokasiMap': lokasiUsaha
        })
      })
      .then(response => response.text())
      .then(data => {
        alert('Data telah disimpan!');
        fetchData(); // Update tabel setelah data berhasil disimpan

        // Reset form
        document.getElementById("usahanForm").reset();
        
        // Menampilkan pesan Terima Kasih dengan animasi
        document.getElementById('thankYouMessage').style.display = 'block';
        setTimeout(() => {
          document.getElementById('thankYouMessage').style.display = 'none';
        }, 3000);

        // Kirim notifikasi email
        sendEmailNotification(namaPemilik, namaUsaha, jenisUsaha, lokasiUsaha, nomorHp);
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Terima kesalahan saat menyimpan data. Silakan coba lagi.');
      });
    });

    // Fungsi untuk mengirim notifikasi email
    function sendEmailNotification(namaPemilik, namaUsaha, jenisUsaha, lokasiUsaha, nomorHp) {
        // Parameter untuk template EmailJS
        const templateParams = {
            to_email: 'sewon.ansor@gmail.com',
            from_name: 'Sistem Pendataan Usaha',
            nama_pemilik: namaPemilik,
            nama_usaha: namaUsaha,
            jenis_usaha: jenisUsaha,
            lokasi_usaha: lokasiUsaha,
            nomor_hp: nomorHp
        };

        // Ganti dengan SERVICE_ID dan TEMPLATE_ID kamu
        emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams)
            .then(function(response) {
                console.log('Email notifikasi berhasil dikirim!', response.status, response.text);
                // Bisa tambahkan notifikasi sukses di sini jika diinginkan
            }, function(error) {
                console.error('Gagal mengirim email notifikasi:', error);
                // Bisa tambahkan notifikasi error di sini jika diinginkan
            });
    }

    // Fungsi untuk mengekstrak koordinat dari berbagai format
    function extractCoordinates(locationString) {
      if (!locationString) return null;
      
      // Coba ekstrak dari format "Latitude: X, Longitude: Y"
      let latMatch = locationString.match(/Latitude:\s*(-?\d+\.?\d*)/i);
      let lngMatch = locationString.match(/Longitude:\s*(-?\d+\.?\d*)/i);
      
      if (latMatch && lngMatch) {
        return {
          lat: parseFloat(latMatch[1]),
          lng: parseFloat(lngMatch[1])
        };
      }
      
      // Coba ekstrak dari format koordinat saja (dua angka desimal)
      let coordMatch = locationString.match(/(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)/);
      if (coordMatch && coordMatch.length >= 3) {
        return {
          lat: parseFloat(coordMatch[1]),
          lng: parseFloat(coordMatch[2])
        };
      }
      
      // Coba ekstrak angka desimal saja
      let numbers = locationString.match(/-?\d+\.?\d*/g);
      if (numbers && numbers.length >= 2) {
        return {
          lat: parseFloat(numbers[0]),
          lng: parseFloat(numbers[1])
        };
      }
      
      return null;
    }

    // Peta Sebaran Usaha dengan pencarian manual
    function initMapSebaran() {
      // Hapus peta sebaran yang sudah ada jika ada
      if (mapSebaran) {
        mapSebaran.remove();
        mapSebaran = null;
      }

      // Inisialisasi peta sebaran baru
      mapSebaran = L.map('mapSebaran').setView([-6.200000, 106.816666], 12);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(mapSebaran);

      markersGroup = L.markerClusterGroup();
      mapSebaran.addLayer(markersGroup);
      allMarkers = []; // Reset array markers

      fetch('https://script.google.com/macros/s/AKfycbydjbuQJ9MA_ZxRQALkrvE-eEBgoSx4Dr5B-KHMAPSk0DXwQlUSbtGDiBH_Q-tr5WS5bw/exec')
        .then(response => response.json())
        .then(data => {
          markersGroup.clearLayers();
          allMarkers = []; // Reset array markers

          let validMarkersCount = 0;
          
          data.forEach(row => {
            if (row.lokasiMap) {
              // Gunakan fungsi extractCoordinates yang baru
              let coords = extractCoordinates(row.lokasiMap);
              
              if (coords && coords.lat && coords.lng) {
                let lat = coords.lat;
                let lng = coords.lng;

                // Validasi koordinat (Indonesia sekitar -11 sampai 6 untuk latitude, 95 sampai 141 untuk longitude)
                if (lat >= -11 && lat <= 6 && lng >= 95 && lng <= 141) {
                  const gmapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;

                  // Buat marker dengan popup
                  let marker = L.marker([lat, lng]).bindPopup(`
                    <b>${row.namaUsaha || 'Tidak ada nama'}</b><br>
                    <b>Pemilik:</b> ${row.namaPemilik || 'Tidak ada'}<br>
                    <b>Jenis:</b> ${row.jenisUsaha || 'Tidak ada'}<br>
                    <b>HP:</b> ${row.nomorHp || 'Tidak ada'}<br>
                    <a href="${gmapsUrl}" target="_blank">Lihat di Google Maps</a>
                  `);

                  // Simpan data di properti marker untuk pencarian
                  marker.feature = {
                    properties: {
                      namaUsaha: row.namaUsaha || '',
                      namaPemilik: row.namaPemilik || '',
                      jenisUsaha: row.jenisUsaha || '',
                      nomorHp: row.nomorHp || ''
                    }
                  };

                  markersGroup.addLayer(marker);
                  allMarkers.push(marker); // Simpan ke array untuk pencarian
                  validMarkersCount++;
                } else {
                  console.warn('Koordinat di luar Indonesia untuk:', row.namaUsaha, 'Lokasi:', row.lokasiMap);
                }
              } else {
                console.warn('Koordinat tidak valid untuk:', row.namaUsaha, 'Lokasi:', row.lokasiMap);
              }
            } else {
              console.warn('LokasiMap kosong untuk:', row.namaUsaha);
            }
          });
          
          if (validMarkersCount > 0) {
            mapSebaran.fitBounds(markersGroup.getBounds());
            console.log(`Berhasil menampilkan ${validMarkersCount} marker di peta`);
          } else {
            // Jika tidak ada marker yang valid, tetap di lokasi default
            mapSebaran.setView([-6.200000, 106.816666], 12);
            console.warn('Tidak ada marker yang valid untuk ditampilkan');
          }

          // Setelah semua marker dimuat, tambahkan event listener untuk pencarian
          setupMapSearch();
        })
        .catch(error => console.error('Error fetching map ', error));
    }

    // Fungsi pencarian manual di peta
    function setupMapSearch() {
        const searchInput = document.getElementById('mapSearchInput');
        
        searchInput.addEventListener('input', function(e) {
            const searchText = e.target.value.toLowerCase();
            
            if (searchText.length === 0) {
                // Jika input kosong, jangan lakukan apa-apa, biarkan semua marker terlihat
                return;
            }

            // Cari marker yang cocok
            const matchingMarkers = allMarkers.filter(marker => {
                const markerData = marker.feature?.properties || {};
                
                // Periksa apakah nilai adalah string sebelum memanggil toLowerCase
                const namaUsaha = typeof markerData.namaUsaha === 'string' ? markerData.namaUsaha.toLowerCase() : '';
                const namaPemilik = typeof markerData.namaPemilik === 'string' ? markerData.namaPemilik.toLowerCase() : '';
                const jenisUsaha = typeof markerData.jenisUsaha === 'string' ? markerData.jenisUsaha.toLowerCase() : '';
                const nomorHp = typeof markerData.nomorHp === 'string' ? markerData.nomorHp.toLowerCase() : '';
                
                return (
                    namaUsaha.includes(searchText) ||
                    namaPemilik.includes(searchText) ||
                    jenisUsaha.includes(searchText) ||
                    nomorHp.includes(searchText)
                );
            });

            // Jika hanya ada 1 hasil, langsung fokus ke lokasi itu
            if (matchingMarkers.length === 1) {
                const latlng = matchingMarkers[0].getLatLng();
                mapSebaran.setView(latlng, 16);
                matchingMarkers[0].openPopup();
            }
            // Jika ada lebih dari 1 hasil, fokus ke area yang mencakup semua hasil
            else if (matchingMarkers.length > 1) {
                const group = L.featureGroup(matchingMarkers);
                mapSebaran.fitBounds(group.getBounds());
            }
        });
    }

    // Toggle map visibility when button is clicked
    function toggleMapSebaran() {
      const mapContainer = document.getElementById('mapSebaranContainer');
      const button = document.getElementById('showMapButton');

      if (mapContainer.style.display === 'none') {
        mapContainer.style.display = 'block';
        button.textContent = 'Sembunyikan Peta Sebaran';
        initMapSebaran(); // Initialize map only when it is shown
        setTimeout(() => {
          if (mapSebaran) {
            mapSebaran.invalidateSize(); // Update ukuran peta setelah ditampilkan
          }
        }, 300);
      } else {
        mapContainer.style.display = 'none';
        button.textContent = 'Tampilkan Peta Sebaran';
      }
    }

    // Toggle table visibility when button is clicked
    function toggleTable() {
      const tableContainer = document.getElementById('tableContainer');
      const button = document.getElementById('toggleTableButton');

      if (tableContainer.style.display === 'none') {
        tableContainer.style.display = 'block';
        button.textContent = 'Sembunyikan Tabel';
      } else {
        tableContainer.style.display = 'none';
        button.textContent = 'Tampilkan Tabel';
      }
    }

    // Toggle form visibility
    function toggleFormVisibility() {
      const form = document.getElementById('addBusinessForm');
      if (form.style.display === 'none') {
        form.style.display = 'block';
        // Pastikan peta form di-update ukurannya
        setTimeout(() => {
          map.invalidateSize();
        }, 300);
      } else {
        form.style.display = 'none';
      }
    }
  </script>
</body>
</html>