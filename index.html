<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pendataan Usaha Anggota GP Ansor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="icon" type="image/webp" href="Ansor_emblem.webp">
  <style>
    :root {
      --primary-color: #2C3E50;
      --secondary-color: #3498DB;
      --success-color: #28a745;
      --warning-color: #FFC107;
      --danger-color: #DC3545;
      --light-color: #F8F9FA;
      --dark-color: #343A40;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary-color), #1a2530);
      color: white;
      padding: 30px;
      text-align: center;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      margin-bottom: 25px;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.05)"/></svg>');
      background-size: cover;
    }

    .header img {
      max-height: 100px;
      margin-bottom: 10px;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
      position: relative;
      z-index: 1;
    }

    .header img:hover {
      transform: scale(1.15);
      filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.3)) brightness(1.1);
    }

    .header h1 {
      font-weight: 700;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .card {
      margin: 15px 0;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: none;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }
    
    .card-header {
      background: linear-gradient(135deg, var(--secondary-color), #2980B9);
      color: white;
      font-weight: 600;
      border-bottom: none;
      padding: 15px 20px;
    }

    #map, #mapSebaran {
      height: 400px;
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    #mapSebaran {
      height: 500px;
    }

    .table-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .table th {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 15px;
    }
    
    .table td {
      padding: 10px 15px;
      vertical-align: middle;
    }
    
    .table tbody tr {
      transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
      background-color: rgba(52, 152, 219, 0.05);
    }

    /* Admin Features */
    .admin-only {
      display: none;
    }
    
    .logged-in .admin-only {
      display: table-cell;
    }
    
    .admin-section {
      display: none;
    }
    
    .logged-in .admin-section {
      display: block;
    }
    
    .action-buttons {
      white-space: nowrap;
    }
    
    .btn-action {
      margin: 2px;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .login-section {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10;
    }
    
    .admin-badge {
      background: linear-gradient(135deg, var(--success-color), #20c997);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    #thankYouMessage {
      display: none;
      font-size: 24px;
      color: var(--success-color);
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      animation: fadeIn 0.5s ease;
      padding: 15px;
      background: rgba(40, 167, 69, 0.1);
      border-radius: 8px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    #showMapButton, #toggleTableButton {
      margin-top: 15px;
      display: block;
      width: 100%;
      transition: all 0.3s ease;
      border-radius: 8px;
      padding: 12px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    #showMapButton {
      background: linear-gradient(135deg, var(--secondary-color), #2980B9);
      border: none;
    }
    
    #toggleTableButton {
      background: linear-gradient(135deg, #6C757D, #5A6268);
      border: none;
    }

    #addBusinessButton {
      margin-top: 20px;
      margin-bottom: 20px;
      display: block;
      width: 100%;
      background: linear-gradient(135deg, var(--success-color), #20c997);
      color: white;
      border-radius: 8px;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    #addBusinessButton:hover {
      background: linear-gradient(135deg, #218838, #1e7e34);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
      animation: pulse 1s infinite;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--secondary-color), #2980B9);
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-weight: 600;
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #20c997);
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-weight: 600;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, var(--warning-color), #e0a800);
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-weight: 600;
      color: #212529;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color), #c82333);
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-weight: 600;
    }

    .dataTables_wrapper .dataTables_filter input {
      margin-left: 0;
      width: 300px;
      transition: all 0.3s ease;
      border-radius: 20px;
      padding: 8px 15px;
      border: 1px solid #ced4da;
    }
    
    .dataTables_wrapper .dataTables_filter input:focus {
      width: 350px;
      box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.25);
      border-color: var(--primary-color);
    }
    
    .dataTables_wrapper .dataTables_length {
      float: none;
      margin-bottom: 10px;
    }

    .custom-search-container {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .custom-search-input {
      width: 300px;
      padding: 8px 15px;
      border: 1px solid #ced4da;
      border-radius: 20px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .custom-search-input:focus {
      box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.25);
      border-color: var(--primary-color);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999;
      transform: translateX(120%);
      transition: transform 0.3s ease;
      max-width: 350px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: linear-gradient(135deg, var(--success-color), #20c997);
    }

    .notification.error {
      background: linear-gradient(135deg, var(--danger-color), #c82333);
    }

    .notification.info {
      background: linear-gradient(135deg, var(--secondary-color), #2980B9);
    }

    .loading-spinner {
      display: none;
      text-align: center;
      padding: 30px;
    }
    
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    
    .form-control, .form-select {
      border-radius: 8px;
      padding: 10px 15px;
      border: 1px solid #ced4da;
      transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
      box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.25);
      border-color: var(--primary-color);
    }
    
    .modal-header {
      border-bottom: none;
      padding: 20px 25px 10px;
    }
    
    .modal-footer {
      border-top: none;
      padding: 10px 25px 20px;
    }
    
    .stats-card {
      text-align: center;
      padding: 20px;
      border-radius: 10px;
      color: white;
      margin-bottom: 20px;
    }
    
    .stats-card.total {
      background: linear-gradient(135deg, var(--primary-color), #1a2530);
    }
    
    .stats-card.food {
      background: linear-gradient(135deg, #E74C3C, #C0392B);
    }
    
    .stats-card.service {
      background: linear-gradient(135deg, #9B59B6, #8E44AD);
    }
    
    .stats-card.other {
      background: linear-gradient(135deg, #F39C12, #E67E22);
    }
    
    .stats-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
    }
    
    .stats-label {
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .user-management-section {
      display: none;
    }
    
    .logged-in .user-management-section {
      display: block;
    }

    /* New styles for selection and bulk actions */
    .row-checkbox {
      margin: 0;
      cursor: pointer;
    }

    .table-primary {
      background-color: rgba(13, 110, 253, 0.1) !important;
    }

    #bulkActionsToolbar {
      border-left: 4px solid #0d6efd;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Highlight untuk baris yang dipilih */
    .table tbody tr.table-primary:hover {
      background-color: rgba(13, 110, 253, 0.2) !important;
    }

    /* FAQ Popup Styles */
    .faq-popup-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    .faq-popup-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--secondary-color), #2980B9);
      color: white;
      border: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 24px;
      position: relative;
    }

    .faq-popup-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .faq-popup-btn.active {
      background: linear-gradient(135deg, var(--primary-color), #1a2530);
    }

    .faq-popup-content {
      position: absolute;
      bottom: 70px;
      right: 0;
      width: 300px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }

    .faq-popup-content.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .faq-popup-header {
      background: linear-gradient(135deg, var(--primary-color), #1a2530);
      color: white;
      padding: 15px;
      border-radius: 12px 12px 0 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .faq-popup-header h5 {
      margin: 0;
      font-weight: 600;
    }

    .faq-popup-close {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }

    .faq-popup-body {
      padding: 0;
      max-height: 400px;
      overflow-y: auto;
    }

    .faq-popup-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
    }

    .faq-popup-item:last-child {
      border-bottom: none;
    }

    .faq-popup-item:hover {
      background-color: #f8f9fa;
    }

    .faq-popup-item i {
      margin-right: 10px;
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    .faq-popup-item.tutorial i {
      color: var(--secondary-color);
    }

    .faq-popup-item.contact i {
      color: var(--success-color);
    }

    .faq-popup-item.refresh i {
      color: var(--warning-color);
    }

    /* FAQ Accordion Styles */
    .faq-accordion .accordion-button {
      font-weight: 600;
      padding: 15px 20px;
      background: linear-gradient(135deg, var(--secondary-color), #2980B9);
      color: white;
      border: none;
      border-radius: 8px !important;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .faq-accordion .accordion-button:not(.collapsed) {
      background: linear-gradient(135deg, var(--primary-color), #1a2530);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .faq-accordion .accordion-button:focus {
      box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
      border: none;
    }

    .faq-accordion .accordion-body {
      padding: 20px;
      background-color: var(--light-color);
      border-radius: 0 0 8px 8px;
      border: 1px solid #e0e0e0;
      border-top: none;
    }

    .faq-item {
      margin-bottom: 10px;
    }

    .faq-question {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .faq-answer {
      color: #666;
      margin-bottom: 15px;
      padding-left: 15px;
      border-left: 3px solid var(--secondary-color);
    }

    /* Background refresh indicator */
    .refresh-indicator {
      position: fixed;
      bottom: 90px;
      right: 20px;
      background: rgba(52, 152, 219, 0.9);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .refresh-indicator.show {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .header img {
        max-height: 80px;
      }
      
      .header h1 {
        font-size: 1.8rem;
      }
      
      .dataTables_wrapper .dataTables_filter input {
        width: 100%;
      }
      
      .dataTables_wrapper .dataTables_filter input:focus {
        width: 100%;
      }
      
      .custom-search-input {
        width: 200px;
      }
      
      .login-section {
        position: relative;
        top: auto;
        right: auto;
        text-align: center;
        margin-bottom: 15px;
      }
      
      .stats-number {
        font-size: 2rem;
      }
      
      .action-buttons {
        white-space: normal;
      }
      
      .btn-action {
        display: block;
        width: 100%;
        margin: 5px 0;
      }
      
      .faq-popup-container {
        bottom: 10px;
        right: 10px;
      }
      
      .faq-popup-content {
        width: 280px;
        right: -10px;
      }
      
      .refresh-indicator {
        bottom: 80px;
        right: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="header">
      <div class="login-section">
        <div id="loginSection">
          <button class="btn btn-outline-light btn-sm" onclick="showLoginModal()">
            <i class="fas fa-lock"></i> Login Admin
          </button>
        </div>
        <div id="adminSection" style="display: none;">
          <span class="admin-badge" id="adminBadge">Admin</span>
          <button class="btn btn-outline-light btn-sm ms-2" onclick="showUserManagement()">
            <i class="fas fa-users"></i> Kelola User
          </button>
          <button class="btn btn-outline-light btn-sm ms-2" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>
      
      <img src="Ansor_emblem.webp" alt="Logo GP Ansor" class="logo-interactive">
      <h1>Pendataan Usaha Anggota</h1>
      <p>Manajemen data usaha yang dimiliki oleh anggota GP Ansor</p>
    </div>
  </div>

  <div class="container mt-4">
    <!-- Statistik -->
    <div class="row mb-4" id="statsContainer">
      <div class="col-md-3 col-sm-6">
        <div class="stats-card total">
          <div class="stats-number" id="totalBusinesses">0</div>
          <div class="stats-label">Total Usaha</div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stats-card food">
          <div class="stats-number" id="foodBusinesses">0</div>
          <div class="stats-label">Usaha Makanan</div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stats-card service">
          <div class="stats-number" id="serviceBusinesses">0</div>
          <div class="stats-label">Usaha Jasa</div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stats-card other">
          <div class="stats-number" id="otherBusinesses">0</div>
          <div class="stats-label">Usaha Lainnya</div>
        </div>
      </div>
    </div>

    <!-- Tombol untuk menambahkan usaha -->
    <button id="addBusinessButton" onclick="toggleFormVisibility()">
      <i class="fas fa-plus-circle"></i> Tambahkan Usaha Baru
    </button>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Memuat data...</span>
      </div>
      <p class="mt-2">Memuat data...</p>
    </div>

    <!-- Form Input Usaha -->
    <div class="row" id="addBusinessForm" style="display: none;">
      <div class="col-md-8 offset-md-2">
        <div class="card">
          <div class="card-header">
            <h4><i class="fas fa-store"></i> Tambah Usaha Anggota</h4>
          </div>
          <div class="card-body">
            <form id="usahanForm">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="namaPemilik" class="form-label">Nama Pemilik *</label>
                    <input type="text" class="form-control" id="namaPemilik" placeholder="Contoh: Ulinnuha" required>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="namaUsaha" class="form-label">Nama Usaha *</label>
                    <input type="text" class="form-control" id="namaUsaha" placeholder="Contoh: Okebeb Telur Asin" required>
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="jenisUsaha" class="form-label">Jenis Usaha *</label>
                    <select class="form-select" id="jenisUsaha" required>
                      <option value="">Pilih Jenis Usaha</option>
                      <option value="Makanan & Minuman">Makanan & Minuman</option>
                      <option value="Fashion & Pakaian">Fashion & Pakaian</option>
                      <option value="Jasa & Servis">Jasa & Servis</option>
                      <option value="Retail & Toko">Retail & Toko</option>
                      <option value="Pertanian & Perikanan">Pertanian & Perikanan</option>
                      <option value="Teknologi & Elektronik">Teknologi & Elektronik</option>
                      <option value="Lainnya">Lainnya</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="nomorHp" class="form-label">Nomor HP *</label>
                    <input type="tel" class="form-control" id="nomorHp" placeholder="Contoh: 0838xxxxxxxx" required>
                  </div>
                </div>
              </div>

              <!-- Peta untuk input lokasi usaha -->
              <div class="mb-3">
                <label for="lokasiMap" class="form-label">Pilih Lokasi di Peta</label>
                <div id="map"></div>
              </div>
              <div class="mb-3">
                <label for="lokasiUsaha" class="form-label">Lokasi Usaha *</label>
                <input type="text" class="form-control" id="lokasiUsaha" placeholder="Klik peta atau gunakan tombol 'Dapatkan Lokasi Saya'" required>
              </div>
              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-secondary me-md-2" onclick="getLocation()">
                  <i class="fas fa-map-marker-alt"></i> Dapatkan Lokasi Saya
                </button>
                <button type="submit" class="btn btn-primary" id="submitButton">
                  <i class="fas fa-paper-plane"></i> Bismillah Cuan
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Pesan Terima Kasih -->
    <div id="thankYouMessage">
      <i class="fas fa-heart"></i> Terima Kasih Sahabat! Data telah tersimpan.
    </div>

    <!-- Tombol untuk menampilkan Peta Sebaran -->
    <button id="showMapButton" class="btn btn-primary" onclick="toggleMapSebaran()">
      <i class="fas fa-map"></i> Tampilkan Peta Sebaran
    </button>

    <!-- Tombol untuk menampilkan/sembunyikan tabel -->
    <button id="toggleTableButton" class="btn btn-secondary" onclick="toggleTable()">
      <i class="fas fa-table"></i> Sembunyikan Tabel
    </button>

    <!-- Peta Sebaran Usaha -->
    <div class="card mt-5" id="mapSebaranContainer" style="display: none;">
      <div class="card-header">
        <h4><i class="fas fa-map-marked-alt"></i> Peta Sebaran Usaha Anggota</h4>
      </div>
      <div class="card-body">
        <div id="mapSebaran" style="height: 500px; width: 100%; border-radius: 10px; position: relative;">
            <!-- Kontrol pencarian manual -->
            <div class="custom-search-container">
                <input type="text" class="custom-search-input" id="mapSearchInput" placeholder="Cari: usaha, pemilik, jenis...">
            </div>
        </div>
      </div>
    </div>

    <!-- Tabel Daftar Usaha Anggota -->
    <div class="table-container" id="tableContainer">
      <!-- Bulk Actions Toolbar -->
      <div class="admin-only mb-3" id="bulkActionsToolbar" style="display: none;">
        <div class="card bg-light">
          <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
              <span>
                <i class="fas fa-check-circle text-primary"></i>
                <span id="selectedItemsCount">0</span> data dipilih
              </span>
              <div>
                <button class="btn btn-sm btn-outline-danger me-2" onclick="deleteSelectedBusinesses()">
                  <i class="fas fa-trash"></i> Hapus yang Dipilih
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                  <i class="fas fa-times"></i> Batal Pilih
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <table class="table table-bordered table-striped" id="usahanTable">
        <thead>
          <tr>
            <th class="admin-only" width="50">
              <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
            </th>
            <th>#</th>
            <th>Nama Pemilik</th>
            <th>Nama Usaha</th>
            <th>Jenis Usaha</th>
            <th>Lokasi Usaha</th>
            <th>Nomor HP</th>
            <th class="admin-only">Aksi</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data akan dimasukkan di sini -->
        </tbody>
      </table>
      
      <!-- Tombol Hapus Semua (Admin Only) -->
      <div class="admin-only mt-3 text-end">
        <button class="btn btn-danger" onclick="confirmDeleteAll()">
          <i class="fas fa-trash-alt"></i> Hapus Semua Data
        </button>
      </div>
    </div>

    <!-- User Management Section -->
    <div class="user-management-section mt-5">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4><i class="fas fa-users-cog"></i> Kelola User</h4>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Daftar Pengguna Sistem</h5>
            <button class="btn btn-success" onclick="showAddUserModal()">
              <i class="fas fa-user-plus"></i> Tambah User Baru
            </button>
          </div>
          
          <div class="table-responsive">
            <table class="table table-bordered table-striped" id="usersTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Username</th>
                  <th>Nama Lengkap</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Terakhir Login</th>
                  <th>Tanggal Dibuat</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                <!-- Data users akan dimasukkan di sini -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FAQ Popup Container -->
  <div class="faq-popup-container">
    <div class="faq-popup-content" id="faqPopup">
      <div class="faq-popup-header">
        <h5><i class="fas fa-question-circle"></i> Bantuan Cepat</h5>
        <button class="faq-popup-close" onclick="toggleFaqPopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="faq-popup-body">
        <div class="faq-popup-item tutorial" onclick="showTutorialModal()">
          <i class="fas fa-book"></i>
          <span>Tutorial Penggunaan</span>
        </div>
        <div class="faq-popup-item contact" onclick="showContactModal()">
          <i class="fas fa-headset"></i>
          <span>Hubungi Admin</span>
        </div>
        <div class="faq-popup-item refresh" onclick="refreshData()">
          <i class="fas fa-sync-alt"></i>
          <span>Refresh Data</span>
        </div>
      </div>
    </div>
    <button class="faq-popup-btn" id="faqPopupBtn" onclick="toggleFaqPopup()">
      <i class="fas fa-question"></i>
    </button>
  </div>

  <!-- Background Refresh Indicator -->
  <div class="refresh-indicator" id="refreshIndicator">
    <i class="fas fa-sync-alt"></i> Data diperbarui
  </div>

  <!-- Modal Login -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="loginModalLabel"><i class="fas fa-lock"></i> Login Admin</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
              <input type="text" class="form-control" id="username" placeholder="Masukkan username" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control" id="password" placeholder="Masukkan password" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" onclick="login()">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Edit Usaha -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-warning text-white">
          <h5 class="modal-title" id="editModalLabel"><i class="fas fa-edit"></i> Edit Data Usaha</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editRowId">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editNamaPemilik" class="form-label">Nama Pemilik *</label>
                  <input type="text" class="form-control" id="editNamaPemilik" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editNamaUsaha" class="form-label">Nama Usaha *</label>
                  <input type="text" class="form-control" id="editNamaUsaha" required>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editJenisUsaha" class="form-label">Jenis Usaha *</label>
                  <select class="form-select" id="editJenisUsaha" required>
                    <option value="">Pilih Jenis Usaha</option>
                    <option value="Makanan & Minuman">Makanan & Minuman</option>
                    <option value="Fashion & Pakaian">Fashion & Pakaian</option>
                    <option value="Jasa & Servis">Jasa & Servis</option>
                    <option value="Retail & Toko">Retail & Toko</option>
                    <option value="Pertanian & Perikanan">Pertanian & Perikanan</option>
                    <option value="Teknologi & Elektronik">Teknologi & Elektronik</option>
                    <option value="Lainnya">Lainnya</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="editNomorHp" class="form-label">Nomor HP *</label>
                  <input type="tel" class="form-control" id="editNomorHp" required>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="editLokasiUsaha" class="form-label">Lokasi Usaha *</label>
              <textarea class="form-control" id="editLokasiUsaha" rows="3" required></textarea>
              <div class="form-text">Lokasi akan digunakan untuk menampilkan di peta sebaran</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-warning" onclick="updateBusiness()">
            <i class="fas fa-save"></i> Update Data
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Konfirmasi Delete -->
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteConfirmLabel"><i class="fas fa-exclamation-triangle"></i> Konfirmasi Hapus</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <p id="deleteConfirmMessage">Apakah Anda yakin ingin menghapus data ini?</p>
          <div id="multipleDeleteInfo" style="display: none;">
            <div class="alert alert-warning">
              <i class="fas fa-info-circle"></i>
              <strong>Perhatian:</strong> Anda akan menghapus <span id="selectedCount">0</span> data yang dipilih.
            </div>
          </div>
          <div id="allDeleteInfo" style="display: none;">
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>PERINGATAN:</strong> Anda akan menghapus SEMUA data usaha. Tindakan ini tidak dapat dibatalkan!
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteButton">
            <i class="fas fa-trash"></i> Ya, Hapus
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Add User -->
  <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="addUserModalLabel"><i class="fas fa-user-plus"></i> Tambah User Baru</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <form id="addUserForm">
            <div class="mb-3">
              <label for="newUsername" class="form-label">Username *</label>
              <input type="text" class="form-control" id="newUsername" placeholder="Masukkan username" required>
            </div>
            <div class="mb-3">
              <label for="newPassword" class="form-label">Password *</label>
              <input type="password" class="form-control" id="newPassword" placeholder="Masukkan password" required>
            </div>
            <div class="mb-3">
              <label for="newNamaLengkap" class="form-label">Nama Lengkap *</label>
              <input type="text" class="form-control" id="newNamaLengkap" placeholder="Masukkan nama lengkap" required>
            </div>
            <div class="mb-3">
              <label for="newRole" class="form-label">Role *</label>
              <select class="form-select" id="newRole" required>
                <option value="">Pilih Role</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="newStatus" class="form-label">Status</label>
              <select class="form-select" id="newStatus">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="newKeterangan" class="form-label">Keterangan</label>
              <textarea class="form-control" id="newKeterangan" rows="2" placeholder="Keterangan tambahan"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-success" onclick="addUser()">Tambah User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Edit User -->
  <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-white">
          <h5 class="modal-title" id="editUserModalLabel"><i class="fas fa-user-edit"></i> Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <form id="editUserForm">
            <input type="hidden" id="editUserRowId">
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input type="text" class="form-control" id="editUserUsername" readonly>
              <small class="form-text text-muted">Username tidak dapat diubah</small>
            </div>
            <div class="mb-3">
              <label for="editUserPassword" class="form-label">Password (Kosongkan jika tidak diubah)</label>
              <input type="password" class="form-control" id="editUserPassword" placeholder="Masukkan password baru">
            </div>
            <div class="mb-3">
              <label for="editUserNamaLengkap" class="form-label">Nama Lengkap *</label>
              <input type="text" class="form-control" id="editUserNamaLengkap" required>
            </div>
            <div class="mb-3">
              <label for="editUserRole" class="form-label">Role *</label>
              <select class="form-select" id="editUserRole" required>
                <option value="admin">Admin</option>
                <option value="user">User</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editUserStatus" class="form-label">Status</label>
              <select class="form-select" id="editUserStatus">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editUserKeterangan" class="form-label">Keterangan</label>
              <textarea class="form-control" id="editUserKeterangan" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-warning" onclick="updateUser()">Update User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Tutorial FAQ -->
  <div class="modal fade" id="tutorialModal" tabindex="-1" aria-labelledby="tutorialLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title" id="tutorialLabel"><i class="fas fa-question-circle"></i> FAQ & Tutorial Singkat</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <div class="faq-accordion">
            <div class="accordion" id="tutorialAccordion">
              
              <!-- FAQ 1 -->
              <div class="accordion-item faq-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                    <i class="fas fa-user me-2"></i> Bagaimana cara mengisi data pemilik?
                  </button>
                </h2>
                <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#tutorialAccordion">
                  <div class="accordion-body">
                    <p>Isi dengan <strong>nama lengkap pemilik usaha</strong> yang terdaftar sebagai anggota GP Ansor.</p>
                    <p class="text-muted mb-0">Contoh: Ulinnuha</p>
                  </div>
                </div>
              </div>

              <!-- FAQ 2 -->
              <div class="accordion-item faq-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                    <i class="fas fa-store me-2"></i> Bagaimana mengisi nama usaha?
                  </button>
                </h2>
                <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#tutorialAccordion">
                  <div class="accordion-body">
                    <p>Isi <strong>nama usaha sesuai dengan yang dijalankan</strong>. Gunakan nama yang mudah dikenali.</p>
                    <p class="text-muted mb-0">Contoh: Okebeb Telur Asin</p>
                  </div>
                </div>
              </div>

              <!-- FAQ 3 -->
              <div class="accordion-item faq-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                    <i class="fas fa-tags me-2"></i> Bagaimana memilih jenis usaha?
                  </button>
                </h2>
                <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#tutorialAccordion">
                  <div class="accordion-body">
                    <p>Pilih <strong>kategori yang paling sesuai</strong> dengan jenis usaha yang dijalankan.</p>
                    <p class="text-muted mb-0">Pilihan: Makanan & Minuman, Fashion, Jasa, Retail, dll.</p>
                  </div>
                </div>
              </div>

              <!-- FAQ 4 -->
              <div class="accordion-item faq-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                    <i class="fas fa-map-marker-alt me-2"></i> Bagaimana menentukan lokasi?
                  </button>
                </h2>
                <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#tutorialAccordion">
                  <div class="accordion-body">
                    <p><strong>Klik peta</strong> atau gunakan tombol <strong>"Dapatkan Lokasi Saya"</strong> untuk deteksi otomatis.</p>
                    <p class="text-muted mb-0">Pastikan izin lokasi diaktifkan di browser Anda.</p>
                  </div>
                </div>
              </div>

              <!-- FAQ 5 -->
              <div class="accordion-item faq-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq5">
                    <i class="fas fa-mobile-alt me-2"></i> Format nomor HP seperti apa?
                  </button>
                </h2>
                <div id="faq5" class="accordion-collapse collapse" data-bs-parent="#tutorialAccordion">
                  <div class="accordion-body">
                    <p>Gunakan <strong>nomor HP yang aktif</strong> dengan format angka saja atau dengan kode negara.</p>
                    <p class="text-muted mb-0">Contoh: 083812345678 atau +6283812345678</p>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- Tips Penting Section -->
          <div class="mt-4 p-3 bg-light rounded">
            <h6 class="text-primary mb-3"><i class="fas fa-lightbulb"></i> Tips Penting:</h6>
            <div class="row">
              <div class="col-md-6">
                <ul class="small">
                  <li>Pastikan koneksi internet aktif</li>
                  <li>Gunakan browser terbaru</li>
                </ul>
              </div>
              <div class="col-md-6">
                <ul class="small">
                  <li>Data otomatis muncul di peta</li>
                  <li>Admin dapat mengedit data</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
            <i class="fas fa-check"></i> Mengerti
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Kontak Admin Ringkas -->
  <div class="modal fade" id="kontakAdminModal" tabindex="-1" aria-labelledby="kontakAdminLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="kontakAdminLabel"><i class="fab fa-whatsapp"></i> Kontak Admin via WhatsApp</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> 
            <strong>Langsung terhubung dengan Admin</strong> untuk bantuan teknis dan pertanyaan.
          </div>
          
          <form id="kontakAdminForm">
            <div class="mb-3">
              <label class="form-label">Nama Lengkap *</label>
              <input type="text" id="adminNama" class="form-control" placeholder="Nama Anda" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Jenis Kendala *</label>
              <select class="form-select" id="adminJenisKendala" required>
                <option value="">Pilih jenis kendala</option>
                <option value="Teknis">Kendala Teknis</option>
                <option value="Data">Kesalahan Data</option>
                <option value="Fitur">Permintaan Fitur</option>
                <option value="Lainnya">Lainnya</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Deskripsi Kendala *</label>
              <textarea id="adminKendala" class="form-control" rows="3" placeholder="Jelaskan kendala yang dialami..." required></textarea>
            </div>
          </form>

          <div class="mt-4 p-3 bg-light rounded">
            <h6><i class="fas fa-clock"></i> Waktu Respon</h6>
            <p class="small mb-0">Admin biasanya merespon dalam 1-2 jam pada jam kerja (08:00 - 17:00 WIB)</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Batal
          </button>
          <button type="button" class="btn btn-success" onclick="kirimWAAdmin()">
            <i class="fab fa-whatsapp"></i> Buka WhatsApp
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer dengan Gradient -->
  <footer class="mt-5 py-4" style="background: linear-gradient(135deg, var(--primary-color), #1a2530);">
    <div class="container">
      <div class="row">
        <div class="col-md-12 text-center">
          <p class="mb-0 text-white">
            <i class="fas fa-copyright"></i> Hak Cipta 2025 - GP Ansor. Semua Hak Dilindungi.
          </p>
          <p class="small text-light mt-1 opacity-75">
            Sistem Pendataan Usaha Anggota GP Ansor
          </p>
        </div>
      </div>
    </div>
  </footer>
  <!-- Notifikasi -->
  <div id="notification" class="notification"></div>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- JavaScript -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // Variabel global
    let businesses = [];
    let users = [];
    let map;
    let marker;
    let mapSebaran = null;
    let markersGroup;
    let dataTable;
    let usersTable;
    let allMarkers = [];
    let lastDataLength = 0;
    let isFetching = false;
    let adminToken = localStorage.getItem('adminToken') || null;
    let currentUser = null;
    let selectedBusinesses = new Set();
    let currentDeleteAction = null;

    // Variabel untuk optimasi auto-refresh
    let refreshInterval;
    let isUserActive = true;
    let isFormOpen = false;

    // URL Google Apps Script Web App
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxpZ23Xa2u6hgoSfWDUMZaC5ixf5JFzwQ0E-7UzQoOsyiiRY_z2S2u3GPGBx_iYdjmFEw/exec';

    // Inisialisasi peta dan data saat halaman dimuat
    window.onload = function() {
      initMap();
      fetchData(true); // Load data pertama kali dengan spinner
      checkAdminStatus();
      setupUserActivityDetection();
      startAutoRefresh();
      
      // Setup event listener untuk modal delete
      document.getElementById('confirmDeleteButton').addEventListener('click', executeDelete);
    };

    // ==================== OPTIMASI AUTO-REFRESH ====================

    // Fungsi untuk memulai auto-refresh yang cerdas
    function startAutoRefresh() {
      // Refresh setiap 2 menit (120000 ms) dan hanya jika user aktif & form tidak terbuka
      refreshInterval = setInterval(() => {
        if (isUserActive && !isFetching && !isFormOpen) {
          fetchDataSilent(); // Gunakan fetch silent untuk background refresh
        }
      }, 120000);
    }

    // Fungsi fetch data tanpa loading spinner (untuk background refresh)
    async function fetchDataSilent() {
      if (isFetching) return;
      
      isFetching = true;
      // TIDAK memanggil showLoading(true) - tidak tampil loading spinner

      try {
        const response = await fetch(SCRIPT_URL + '?action=getBusinesses&t=' + new Date().getTime());
        
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();

        // Deteksi data baru (hanya tampilkan notifikasi jika ada perubahan)
        if (data.length > lastDataLength) {
          const newEntriesCount = data.length - lastDataLength;
          showBackgroundRefreshIndicator();
        }
        
        lastDataLength = data.length;
        businesses = data;
        renderBusinesses(businesses);
        updateStats(businesses);
        
      } catch (error) {
        console.error('Error fetching data (background):', error);
        // Tidak tampilkan error untuk background refresh
      } finally {
        isFetching = false;
        // TIDAK memanggil showLoading(false)
      }
    }

    // Fungsi fetch data dengan loading spinner (untuk aksi manual)
    async function fetchData(showLoader = true) {
      if (isFetching) return;
      
      isFetching = true;
      if (showLoader) showLoading(true);

      try {
        const response = await fetch(SCRIPT_URL + '?action=getBusinesses&t=' + new Date().getTime());
        
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();

        // Deteksi data baru (hanya tampilkan notifikasi untuk aksi manual)
        if (data.length > lastDataLength && showLoader) {
          const newEntriesCount = data.length - lastDataLength;
          showNotification(`${newEntriesCount} data baru ditambahkan!`, 'info');
        }
        
        lastDataLength = data.length;
        businesses = data;
        renderBusinesses(businesses);
        updateStats(businesses);
        
      } catch (error) {
        console.error('Error fetching data:', error);
        if (showLoader) showNotification('Gagal memuat data', 'error');
      } finally {
        isFetching = false;
        if (showLoader) showLoading(false);
      }
    }

    // Setup deteksi aktivitas user
    function setupUserActivityDetection() {
      let activityTimer;
      
      const resetActivityTimer = () => {
        isUserActive = true;
        clearTimeout(activityTimer);
        activityTimer = setTimeout(() => {
          isUserActive = false; // User dianggap tidak aktif setelah 5 menit
        }, 300000); // 5 menit
      };
      
      // Event listeners untuk deteksi aktivitas
      ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
        document.addEventListener(event, resetActivityTimer, false);
      });
      
      resetActivityTimer(); // Start timer
    }

    // Tampilkan indikator refresh background
    function showBackgroundRefreshIndicator() {
      const indicator = document.getElementById('refreshIndicator');
      indicator.classList.add('show');
      
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 3000);
    }

    // ==================== FUNGSI FAQ POPUP ====================

    // Fungsi untuk toggle FAQ popup
    function toggleFaqPopup() {
      const popup = document.getElementById('faqPopup');
      const button = document.getElementById('faqPopupBtn');
      
      popup.classList.toggle('active');
      button.classList.toggle('active');
    }

    // Fungsi untuk menampilkan modal tutorial dari FAQ
    function showTutorialModal() {
      const tutorialModal = new bootstrap.Modal(document.getElementById('tutorialModal'));
      tutorialModal.show();
      toggleFaqPopup();
    }

    // Fungsi untuk menampilkan modal kontak dari FAQ
    function showContactModal() {
      const contactModal = new bootstrap.Modal(document.getElementById('kontakAdminModal'));
      contactModal.show();
      toggleFaqPopup();
    }

    // ==================== FUNGSI SISTEM LOGIN ====================

    // Fungsi untuk mengecek status admin
    function checkAdminStatus() {
      if (adminToken) {
        // Verifikasi token dengan server
        fetch(`${SCRIPT_URL}?action=checkAuth&token=${adminToken}`)
          .then(response => response.json())
          .then(data => {
            if (data.valid) {
              currentUser = data.user;
              showAdminUI();
              fetchUsers(); // Load users data
            } else {
              logout();
            }
          })
          .catch(() => logout());
      }
    }

    // Fungsi untuk menampilkan UI admin
    function showAdminUI() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminSection').style.display = 'block';
      document.getElementById('adminBadge').textContent = currentUser.username;
      document.body.classList.add('logged-in');
    }

    // Fungsi untuk menyembunyikan UI admin
    function hideAdminUI() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('adminSection').style.display = 'none';
      document.body.classList.remove('logged-in');
    }

    // Fungsi login
    function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      if (!username || !password) {
        showNotification('Username dan password harus diisi', 'error');
        return;
      }

      const formData = new URLSearchParams({
        action: 'login',
        username: username,
        password: password
      });

      fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          adminToken = data.token;
          localStorage.setItem('adminToken', adminToken);
          currentUser = { username: username, role: data.role };
          showNotification('Login berhasil!', 'success');
          bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
          showAdminUI();
          fetchUsers(); // Load users data
          fetchData(false); // Refresh data tanpa loader
        } else {
          showNotification('Login gagal: ' + data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Login error:', error);
        showNotification('Terjadi kesalahan saat login', 'error');
      });
    }

    // Fungsi logout
    function logout() {
      adminToken = null;
      currentUser = null;
      localStorage.removeItem('adminToken');
      hideAdminUI();
      showNotification('Anda telah logout', 'info');
      fetchData(false); // Refresh data tanpa loader
    }

    // Fungsi untuk menampilkan modal login
    function showLoginModal() {
      const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
      loginModal.show();
    }

    // ==================== FUNGSI USER MANAGEMENT ====================

    // Fungsi untuk menampilkan user management
    function showUserManagement() {
      fetchUsers();
      // Scroll to user management section
      document.querySelector('.user-management-section').scrollIntoView({ 
        behavior: 'smooth' 
      });
    }

    // Fungsi untuk menampilkan modal tambah user
    function showAddUserModal() {
      document.getElementById('addUserForm').reset();
      const addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
      addUserModal.show();
    }

    // Fungsi untuk menampilkan modal edit user
    function showEditUserModal(user) {
      document.getElementById('editUserRowId').value = user.rowId;
      document.getElementById('editUserUsername').value = user.username;
      document.getElementById('editUserNamaLengkap').value = user.namaLengkap;
      document.getElementById('editUserRole').value = user.role;
      document.getElementById('editUserStatus').value = user.status;
      document.getElementById('editUserKeterangan').value = user.keterangan || '';
      document.getElementById('editUserPassword').value = '';
      
      const editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
      editUserModal.show();
    }

    // Fungsi untuk mengambil data users
    function fetchUsers() {
      if (!adminToken) {
        console.log('No admin token, skipping users fetch');
        return;
      }

      showLoading(true);
      
      fetch(`${SCRIPT_URL}?action=getUsers&token=${adminToken}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            users = data.users;
            renderUsers(users);
          } else {
            showNotification('Gagal memuat data users: ' + data.message, 'error');
            if (data.message.includes('Akses ditolak') || data.message.includes('Token tidak valid')) {
              logout();
            }
          }
        })
        .catch(error => {
          console.error('Error fetching users:', error);
          showNotification('Gagal memuat data users', 'error');
        })
        .finally(() => {
          showLoading(false);
        });
    }

    // Fungsi untuk render users table
    function renderUsers(usersData) {
      const tableBody = document.querySelector("#usersTable tbody");
      
      if (!tableBody) {
        console.error('Users table body not found');
        return;
      }
      
      tableBody.innerHTML = "";

      if (!usersData || usersData.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              <i class="fas fa-users fa-2x mb-3"></i><br>
              Belum ada data user
            </td>
          </tr>
        `;
        return;
      }

      usersData.forEach((user, index) => {
        // Format tanggal
        const createdDate = user.tanggalDibuat ? new Date(user.tanggalDibuat).toLocaleDateString('id-ID') : '-';
        const lastLogin = user.terakhirLogin ? new Date(user.terakhirLogin).toLocaleString('id-ID') : '-';

        const rowHtml = `
          <tr>
            <td>${index + 1}</td>
            <td>${escapeHtml(user.username)}</td>
            <td>${escapeHtml(user.namaLengkap)}</td>
            <td><span class="badge ${user.role === 'admin' ? 'bg-primary' : 'bg-secondary'}">${user.role}</span></td>
            <td><span class="badge ${user.status === 'active' ? 'bg-success' : 'bg-danger'}">${user.status}</span></td>
            <td>${lastLogin}</td>
            <td>${createdDate}</td>
            <td class="action-buttons">
              <button class="btn btn-warning btn-action" onclick="showEditUserModal(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="btn btn-danger btn-action" onclick="deleteUser(${user.rowId})" ${user.username === currentUser.username ? 'disabled' : ''}>
                <i class="fas fa-trash"></i> Hapus
              </button>
            </td>
          </tr>
        `;
        tableBody.innerHTML += rowHtml;
      });

      // Inisialisasi DataTable untuk users
      if ($.fn.DataTable.isDataTable('#usersTable')) {
        $('#usersTable').DataTable().destroy();
      }

      usersTable = $('#usersTable').DataTable({
        "pageLength": 10,
        "lengthMenu": [5, 10, 25, 50],
        "language": {
          "search": "Cari:",
          "lengthMenu": "Tampilkan _MENU_ data per halaman",
          "zeroRecords": "Tidak ada data user yang ditemukan",
          "info": "Menampilkan halaman _PAGE_ dari _PAGES_",
          "infoEmpty": "Tidak ada data user tersedia",
          "infoFiltered": "(disaring dari _MAX_ total user)"
        }
      });
    }

    // Fungsi untuk menambah user
    function addUser() {
      const username = document.getElementById('newUsername').value;
      const password = document.getElementById('newPassword').value;
      const namaLengkap = document.getElementById('newNamaLengkap').value;
      const role = document.getElementById('newRole').value;
      const status = document.getElementById('newStatus').value;
      const keterangan = document.getElementById('newKeterangan').value;

      if (!username || !password || !namaLengkap || !role) {
        showNotification('Semua field wajib diisi!', 'error');
        return;
      }

      const formData = new URLSearchParams({
        action: 'addUser',
        token: adminToken,
        username: username,
        password: password,
        namaLengkap: namaLengkap,
        role: role,
        status: status,
        keterangan: keterangan
      });

      fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          showNotification('User berhasil ditambahkan!', 'success');
          bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
          fetchUsers(); // Refresh users data
        } else {
          showNotification('Gagal menambah user: ' + data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Add user error:', error);
        showNotification('Terjadi kesalahan saat menambah user', 'error');
      });
    }

    // Fungsi untuk update user
    function updateUser() {
      const rowId = document.getElementById('editUserRowId').value;
      const password = document.getElementById('editUserPassword').value;
      const namaLengkap = document.getElementById('editUserNamaLengkap').value;
      const role = document.getElementById('editUserRole').value;
      const status = document.getElementById('editUserStatus').value;
      const keterangan = document.getElementById('editUserKeterangan').value;

      if (!namaLengkap || !role) {
        showNotification('Nama lengkap dan role wajib diisi!', 'error');
        return;
      }

      const formData = new URLSearchParams({
        action: 'updateUser',
        token: adminToken,
        rowId: rowId,
        namaLengkap: namaLengkap,
        role: role,
        status: status,
        keterangan: keterangan
      });

      // Tambahkan password hanya jika diisi
      if (password) {
        formData.append('password', password);
      }

      fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          showNotification('User berhasil diupdate!', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
          fetchUsers(); // Refresh users data
        } else {
          showNotification('Gagal update user: ' + data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Update user error:', error);
        showNotification('Terjadi kesalahan saat update user', 'error');
      });
    }

    // Fungsi untuk delete user
    function deleteUser(rowId) {
      if (!confirm('Apakah Anda yakin ingin menghapus user ini?')) {
        return;
      }

      const formData = new URLSearchParams({
        action: 'deleteUser',
        token: adminToken,
        rowId: rowId
      });

      fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          showNotification('User berhasil dihapus!', 'success');
          fetchUsers(); // Refresh users data
        } else {
          showNotification('Gagal menghapus user: ' + data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Delete user error:', error);
        showNotification('Terjadi kesalahan saat menghapus user', 'error');
      });
    }

    // ==================== FUNGSI DATA BUSINESS ====================

    // Fungsi untuk render tabel businesses
    function renderBusinesses(data) {
      const tableBody = document.querySelector("#usahanTable tbody");
      tableBody.innerHTML = "";

      data.forEach((business, index) => {
        const checkbox = adminToken ? `
          <td class="admin-only">
            <input type="checkbox" class="row-checkbox" value="${business.rowId}" onchange="toggleBusinessSelection(${business.rowId}, this.checked)">
          </td>
        ` : '<td class="admin-only"></td>';

        const actionButtons = adminToken ? `
          <td class="admin-only action-buttons">
            <button class="btn btn-warning btn-action" onclick="showEditModal(${JSON.stringify(business).replace(/"/g, '&quot;')})">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn btn-danger btn-action" onclick="confirmDeleteBusiness(${business.rowId}, '${escapeHtml(business.namaUsaha)}')">
              <i class="fas fa-trash"></i> Hapus
            </button>
          </td>
        ` : '<td class="admin-only"></td>';

        const rowHtml = `
          <tr id="row-${business.rowId}">
            ${checkbox}
            <td>${index + 1}</td>
            <td>${escapeHtml(business.namaPemilik)}</td>
            <td>${escapeHtml(business.namaUsaha)}</td>
            <td>${escapeHtml(business.jenisUsaha)}</td>
            <td>${escapeHtml(business.lokasiUsaha)}</td>
            <td>${escapeHtml(business.nomorHp)}</td>
            ${actionButtons}
          </tr>
        `;
        tableBody.innerHTML += rowHtml;
      });

      // Reset selection
      selectedBusinesses.clear();
      updateBulkActionsToolbar();

      // Inisialisasi DataTable
      if ($.fn.DataTable.isDataTable('#usahanTable')) {
        $('#usahanTable').DataTable().destroy();
      }

      dataTable = $('#usahanTable').DataTable({
        "pageLength": 10,
        "lengthMenu": [5, 10, 25, 50],
        "language": {
          "search": "Cari:",
          "lengthMenu": "Tampilkan _MENU_ data per halaman",
          "zeroRecords": "Tidak ada data yang ditemukan",
          "info": "Menampilkan halaman _PAGE_ dari _PAGES_",
          "infoEmpty": "Tidak ada data tersedia",
          "infoFiltered": "(disaring dari _MAX_ total data)"
        }
      });
    }

    // ==================== FUNGSI EDIT BUSINESS ====================

    // Fungsi untuk menampilkan modal edit business
    function showEditModal(business) {
      document.getElementById('editRowId').value = business.rowId;
      document.getElementById('editNamaPemilik').value = business.namaPemilik;
      document.getElementById('editNamaUsaha').value = business.namaUsaha;
      document.getElementById('editJenisUsaha').value = business.jenisUsaha;
      document.getElementById('editNomorHp').value = business.nomorHp;
      document.getElementById('editLokasiUsaha').value = business.lokasiUsaha;
      
      const editModal = new bootstrap.Modal(document.getElementById('editModal'));
      editModal.show();
      
      // Focus ke field pertama
      setTimeout(() => {
        document.getElementById('editNamaPemilik').focus();
      }, 500);
    }

    // Fungsi untuk update business
    function updateBusiness() {
      const rowId = document.getElementById('editRowId').value;
      const namaPemilik = document.getElementById('editNamaPemilik').value;
      const namaUsaha = document.getElementById('editNamaUsaha').value;
      const jenisUsaha = document.getElementById('editJenisUsaha').value;
      const nomorHp = document.getElementById('editNomorHp').value;
      const lokasiUsaha = document.getElementById('editLokasiUsaha').value;

      // Validasi input
      if (!namaPemilik || !namaUsaha || !jenisUsaha || !nomorHp || !lokasiUsaha) {
        showNotification('Semua field wajib diisi!', 'error');
        return;
      }

      const formData = new URLSearchParams({
        action: 'updateBusiness',
        token: adminToken,
        rowId: rowId,
        namaPemilik: namaPemilik,
        namaUsaha: namaUsaha,
        jenisUsaha: jenisUsaha,
        nomorHp: nomorHp,
        lokasiUsaha: lokasiUsaha,
        lokasiMap: lokasiUsaha
      });

      fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          showNotification('Data berhasil diupdate!', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
          fetchData(false); // Refresh data tanpa loader
        } else {
          showNotification('Gagal update: ' + data.message, 'error');
          if (data.message.includes('Akses ditolak')) {
            logout();
          }
        }
      })
      .catch(error => {
        console.error('Update error:', error);
        showNotification('Terjadi kesalahan saat update', 'error');
      });
    }

    // ==================== FUNGSI SELECTION MANAGEMENT ====================

    // Fungsi untuk toggle select all
    function toggleSelectAll(checkbox) {
      const rowCheckboxes = document.querySelectorAll('.row-checkbox');
      rowCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        toggleBusinessSelection(parseInt(cb.value), checkbox.checked);
      });
    }

    // Fungsi untuk toggle selection individual business
    function toggleBusinessSelection(rowId, isSelected) {
      if (isSelected) {
        selectedBusinesses.add(rowId);
        document.querySelector(`#row-${rowId}`).classList.add('table-primary');
      } else {
        selectedBusinesses.delete(rowId);
        document.querySelector(`#row-${rowId}`).classList.remove('table-primary');
        document.getElementById('selectAllCheckbox').checked = false;
      }
      updateBulkActionsToolbar();
    }

    // Fungsi untuk update bulk actions toolbar
    function updateBulkActionsToolbar() {
      const toolbar = document.getElementById('bulkActionsToolbar');
      const countElement = document.getElementById('selectedItemsCount');
      
      if (selectedBusinesses.size > 0) {
        toolbar.style.display = 'block';
        countElement.textContent = selectedBusinesses.size;
      } else {
        toolbar.style.display = 'none';
      }
    }

    // Fungsi untuk clear selection
    function clearSelection() {
      selectedBusinesses.clear();
      const rowCheckboxes = document.querySelectorAll('.row-checkbox');
      rowCheckboxes.forEach(cb => {
        cb.checked = false;
        const rowId = parseInt(cb.value);
        document.querySelector(`#row-${rowId}`).classList.remove('table-primary');
      });
      document.getElementById('selectAllCheckbox').checked = false;
      updateBulkActionsToolbar();
    }

    // ==================== FUNGSI DELETE OPERATIONS ====================

    // Fungsi untuk konfirmasi delete single business
    function confirmDeleteBusiness(rowId, businessName) {
      currentDeleteAction = {
        type: 'single',
        rowId: rowId
      };
      
      document.getElementById('deleteConfirmMessage').innerHTML = 
        `Apakah Anda yakin ingin menghapus usaha <strong>"${escapeHtml(businessName)}"</strong>?`;
      document.getElementById('multipleDeleteInfo').style.display = 'none';
      document.getElementById('allDeleteInfo').style.display = 'none';
      
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
      deleteModal.show();
    }

    // Fungsi untuk konfirmasi delete selected businesses
    function deleteSelectedBusinesses() {
      if (selectedBusinesses.size === 0) {
        showNotification('Tidak ada data yang dipilih', 'error');
        return;
      }
      
      currentDeleteAction = {
        type: 'multiple',
        rowIds: Array.from(selectedBusinesses)
      };
      
      document.getElementById('deleteConfirmMessage').textContent = 
        'Apakah Anda yakin ingin menghapus data yang dipilih?';
      document.getElementById('selectedCount').textContent = selectedBusinesses.size;
      document.getElementById('multipleDeleteInfo').style.display = 'block';
      document.getElementById('allDeleteInfo').style.display = 'none';
      
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
      deleteModal.show();
    }

    // Fungsi untuk konfirmasi delete all businesses
    function confirmDeleteAll() {
      if (businesses.length === 0) {
        showNotification('Tidak ada data untuk dihapus', 'info');
        return;
      }
      
      currentDeleteAction = {
        type: 'all'
      };
      
      document.getElementById('deleteConfirmMessage').textContent = 
        'Apakah Anda yakin ingin menghapus semua data usaha?';
      document.getElementById('multipleDeleteInfo').style.display = 'none';
      document.getElementById('allDeleteInfo').style.display = 'block';
      
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
      deleteModal.show();
    }

    // Fungsi untuk execute delete berdasarkan type
    function executeDelete() {
      if (!currentDeleteAction) return;

      let formData;
      
      switch (currentDeleteAction.type) {
        case 'single':
          formData = new URLSearchParams({
            action: 'deleteBusiness',
            token: adminToken,
            rowId: currentDeleteAction.rowId
          });
          break;
          
        case 'multiple':
          formData = new URLSearchParams({
            action: 'deleteBusinesses',
            token: adminToken,
            rowIds: JSON.stringify(currentDeleteAction.rowIds)
          });
          break;
          
        case 'all':
          formData = new URLSearchParams({
            action: 'deleteAllBusinesses',
            token: adminToken
          });
          break;
      }

      fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          let message = '';
          switch (currentDeleteAction.type) {
            case 'single':
              message = 'Data berhasil dihapus!';
              break;
            case 'multiple':
              message = `${currentDeleteAction.rowIds.length} data berhasil dihapus!`;
              break;
            case 'all':
              message = 'Semua data berhasil dihapus!';
              break;
          }
          
          showNotification(message, 'success');
          bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
          fetchData(false); // Refresh data tanpa loader
          clearSelection();
        } else {
          showNotification('Gagal menghapus: ' + data.message, 'error');
          if (data.message.includes('Akses ditolak')) {
            logout();
          }
        }
      })
      .catch(error => {
        console.error('Delete error:', error);
        showNotification('Terjadi kesalahan saat menghapus', 'error');
      });
    }

    // ==================== FUNGSI UI/UX ====================

    // Fungsi untuk toggle form visibility
    function toggleFormVisibility() {
      const form = document.getElementById('addBusinessForm');
      if (form.style.display === 'none') {
        form.style.display = 'block';
        isFormOpen = true; // Set flag form terbuka
        setTimeout(() => {
          map.invalidateSize();
        }, 300);
      } else {
        form.style.display = 'none';
        isFormOpen = false; // Set flag form tertutup
      }
    }

    // Fungsi untuk toggle table visibility
    function toggleTable() {
      const tableContainer = document.getElementById('tableContainer');
      const button = document.getElementById('toggleTableButton');

      if (tableContainer.style.display === 'none') {
        tableContainer.style.display = 'block';
        button.innerHTML = '<i class="fas fa-table"></i> Sembunyikan Tabel';
      } else {
        tableContainer.style.display = 'none';
        button.innerHTML = '<i class="fas fa-table"></i> Tampilkan Tabel';
      }
    }

    // Fungsi untuk toggle map sebaran visibility
    function toggleMapSebaran() {
      const mapContainer = document.getElementById('mapSebaranContainer');
      const button = document.getElementById('showMapButton');

      if (mapContainer.style.display === 'none') {
        mapContainer.style.display = 'block';
        button.innerHTML = '<i class="fas fa-map"></i> Sembunyikan Peta Sebaran';
        initMapSebaran();
        setTimeout(() => {
          if (mapSebaran) {
            mapSebaran.invalidateSize();
          }
        }, 300);
      } else {
        mapContainer.style.display = 'none';
        button.innerHTML = '<i class="fas fa-map"></i> Tampilkan Peta Sebaran';
      }
    }

    // Fungsi untuk refresh data manual
    function refreshData() {
      showNotification('Memperbarui data...', 'info');
      fetchData(true); // Dengan loader
      if (adminToken) {
        fetchUsers();
      }
      if (document.getElementById('faqPopup').classList.contains('active')) {
        toggleFaqPopup();
      }
    }

    // Fungsi untuk menampilkan loading spinner
    function showLoading(show) {
      document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    // ==================== FUNGSI PETA ====================

    // Fungsi untuk inisialisasi peta
    function initMap() {
      map = L.map('map').setView([-6.200000, 106.816666], 12);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker([-6.200000, 106.816666], { draggable: true }).addTo(map);

      marker.on('dragend', function(event) {
        const latLng = marker.getLatLng();
        document.getElementById('lokasiUsaha').value = `Latitude: ${latLng.lat}, Longitude: ${latLng.lng}`;
      });

      map.on('click', function(e) {
        const latLng = e.latlng;
        marker.setLatLng(latLng);
        document.getElementById('lokasiUsaha').value = `Latitude: ${latLng.lat}, Longitude: ${latLng.lng}`;
      });

      map.invalidateSize();
    }

    // Fungsi untuk inisialisasi peta sebaran
    function initMapSebaran() {
      if (mapSebaran) {
        mapSebaran.remove();
        mapSebaran = null;
      }

      mapSebaran = L.map('mapSebaran').setView([-6.200000, 106.816666], 12);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(mapSebaran);

      markersGroup = L.markerClusterGroup();
      mapSebaran.addLayer(markersGroup);
      allMarkers = [];

      // Gunakan data yang sudah di-load, tidak fetch ulang
      let validMarkersCount = 0;
      
      businesses.forEach(row => {
        if (row.lokasiMap) {
          let coords = extractCoordinates(row.lokasiMap);
          
          if (coords && coords.lat && coords.lng) {
            let lat = coords.lat;
            let lng = coords.lng;

            // Validasi koordinat Indonesia
            if (lat >= -11 && lat <= 6 && lng >= 95 && lng <= 141) {
              const gmapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;

              let marker = L.marker([lat, lng]).bindPopup(`
                <div class="p-2">
                  <h5><strong>${row.namaUsaha || 'Tidak ada nama'}</strong></h5>
                  <p><strong>Pemilik:</strong> ${row.namaPemilik || 'Tidak ada'}</p>
                  <p><strong>Jenis:</strong> ${row.jenisUsaha || 'Tidak ada'}</p>
                  <p><strong>HP:</strong> ${row.nomorHp || 'Tidak ada'}</p>
                  <a href="${gmapsUrl}" target="_blank" class="btn btn-sm btn-primary mt-2">Lihat di Google Maps</a>
                </div>
              `);

              marker.feature = {
                properties: {
                  namaUsaha: row.namaUsaha || '',
                  namaPemilik: row.namaPemilik || '',
                  jenisUsaha: row.jenisUsaha || '',
                  nomorHp: row.nomorHp || ''
                }
              };

              markersGroup.addLayer(marker);
              allMarkers.push(marker);
              validMarkersCount++;
            }
          }
        }
      });
      
      if (validMarkersCount > 0) {
        mapSebaran.fitBounds(markersGroup.getBounds());
      } else {
        mapSebaran.setView([-6.200000, 106.816666], 12);
      }

      setupMapSearch();
    }

    // Fungsi untuk mengekstrak koordinat dari string
    function extractCoordinates(locationString) {
      if (!locationString) return null;
      
      let latMatch = locationString.match(/Latitude:\s*(-?\d+\.?\d*)/i);
      let lngMatch = locationString.match(/Longitude:\s*(-?\d+\.?\d*)/i);
      
      if (latMatch && lngMatch) {
        return {
          lat: parseFloat(latMatch[1]),
          lng: parseFloat(lngMatch[1])
        };
      }
      
      let coordMatch = locationString.match(/(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)/);
      if (coordMatch && coordMatch.length >= 3) {
        return {
          lat: parseFloat(coordMatch[1]),
          lng: parseFloat(coordMatch[2])
        };
      }
      
      let numbers = locationString.match(/-?\d+\.?\d*/g);
      if (numbers && numbers.length >= 2) {
        return {
          lat: parseFloat(numbers[0]),
          lng: parseFloat(numbers[1])
        };
      }
      
      return null;
    }

    // Fungsi untuk setup pencarian di peta
    function setupMapSearch() {
        const searchInput = document.getElementById('mapSearchInput');
        
        searchInput.addEventListener('input', function(e) {
            const searchText = e.target.value.toLowerCase();
            
            if (searchText.length === 0) return;

            const matchingMarkers = allMarkers.filter(marker => {
                const markerData = marker.feature?.properties || {};
                
                const namaUsaha = typeof markerData.namaUsaha === 'string' ? markerData.namaUsaha.toLowerCase() : '';
                const namaPemilik = typeof markerData.namaPemilik === 'string' ? markerData.namaPemilik.toLowerCase() : '';
                const jenisUsaha = typeof markerData.jenisUsaha === 'string' ? markerData.jenisUsaha.toLowerCase() : '';
                const nomorHp = typeof markerData.nomorHp === 'string' ? markerData.nomorHp.toLowerCase() : '';
                
                return (
                    namaUsaha.includes(searchText) ||
                    namaPemilik.includes(searchText) ||
                    jenisUsaha.includes(searchText) ||
                    nomorHp.includes(searchText)
                );
            });

            if (matchingMarkers.length === 1) {
                const latlng = matchingMarkers[0].getLatLng();
                mapSebaran.setView(latlng, 16);
                matchingMarkers[0].openPopup();
            } else if (matchingMarkers.length > 1) {
                const group = L.featureGroup(matchingMarkers);
                mapSebaran.fitBounds(group.getBounds());
            }
        });
    }

    // Fungsi untuk get location
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          map.setView([lat, lng], 15);
          marker.setLatLng([lat, lng]);
          document.getElementById('lokasiUsaha').value = `Latitude: ${lat}, Longitude: ${lng}`;
          marker.bindPopup("Lokasi Anda").openPopup();
          map.invalidateSize();
        }, function() {
          alert("Gagal mendapatkan lokasi Anda. Pastikan izin lokasi diaktifkan.");
        });
      } else {
        alert("Geolocation tidak didukung oleh browser ini.");
      }
    }

    // ==================== FUNGSI UTILITAS ====================

    // Fungsi untuk mengupdate statistik
    function updateStats(data) {
      const total = data.length;
      const food = data.filter(b => b.jenisUsaha && b.jenisUsaha.includes('Makanan')).length;
      const service = data.filter(b => b.jenisUsaha && b.jenisUsaha.includes('Jasa')).length;
      const other = total - food - service;
      
      document.getElementById('totalBusinesses').textContent = total;
      document.getElementById('foodBusinesses').textContent = food;
      document.getElementById('serviceBusinesses').textContent = service;
      document.getElementById('otherBusinesses').textContent = other;
    }

    // Fungsi escape HTML untuk keamanan
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Fungsi untuk menampilkan notifikasi
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification ' + type;
      notification.classList.add('show');

      setTimeout(() => {
        notification.classList.remove('show');
      }, 5000);
    }

    // Kirim WA Admin (versi ringkas)
    function kirimWAAdmin() {
      const nama = document.getElementById("adminNama").value;
      const jenisKendala = document.getElementById("adminJenisKendala").value;
      const kendala = document.getElementById("adminKendala").value;

      if (!nama || !jenisKendala || !kendala) {
        showNotification("Harap isi semua field sebelum mengirim pesan!", "error");
        return;
      }

      const adminNumber = "6283866675521";
      const timestamp = new Date().toLocaleString('id-ID');
      const pesan = `Halo Admin GP Ansor,%0A%0ASaya ingin melaporkan kendala:%0A%0A📋 *Jenis Kendala:* ${encodeURIComponent(jenisKendala)}%0A👤 *Nama:* ${encodeURIComponent(nama)}%0A📝 *Deskripsi:* ${encodeURIComponent(kendala)}%0A⏰ *Waktu:* ${encodeURIComponent(timestamp)}%0A%0ATerima kasih.`;
      
      const url = `https://wa.me/${adminNumber}?text=${pesan}`;

      window.open(url, "_blank");
      
      // Reset form dan tutup modal
      document.getElementById("kontakAdminForm").reset();
      bootstrap.Modal.getInstance(document.getElementById('kontakAdminModal')).hide();
      
      showNotification("WhatsApp dibuka, silakan lanjutkan pengiriman pesan", "info");
    }

    // ==================== EVENT LISTENERS ====================

    // Submit form untuk menambah business (tanpa login)
    document.getElementById("usahanForm").addEventListener("submit", async function(event) {
      event.preventDefault();

      const submitButton = document.getElementById('submitButton');
      const originalText = submitButton.textContent;
      
      submitButton.disabled = true;
      submitButton.textContent = 'Menyimpan...';

      const namaPemilik = document.getElementById("namaPemilik").value.trim();
      const namaUsaha = document.getElementById("namaUsaha").value.trim();
      const jenisUsaha = document.getElementById("jenisUsaha").value;
      const lokasiUsaha = document.getElementById("lokasiUsaha").value.trim();
      const nomorHp = document.getElementById("nomorHp").value.trim();

      if (!namaPemilik || !namaUsaha || !jenisUsaha || !lokasiUsaha || !nomorHp) {
        showNotification('Semua field wajib diisi!', 'error');
        submitButton.disabled = false;
        submitButton.textContent = originalText;
        return;
      }

      if (nomorHp && !/^[0-9\-\+\s\(\)]+$/.test(nomorHp)) {
        showNotification('Nomor HP hanya boleh berisi angka dan simbol (+, -, spasi, kurung)', 'error');
        submitButton.disabled = false;
        submitButton.textContent = originalText;
        return;
      }

      try {
        const formData = new URLSearchParams({
          action: 'addBusiness',
          'namaPemilik': namaPemilik,
          'namaUsaha': namaUsaha,
          'jenisUsaha': jenisUsaha,
          'lokasiUsaha': lokasiUsaha,
          'nomorHp': nomorHp,
          'lokasiMap': lokasiUsaha
        });

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.status === 'success') {
          showNotification('Data berhasil disimpan!', 'success');
          fetchData(false); // Refresh data tanpa loader

          document.getElementById("usahanForm").reset();
          
          document.getElementById('thankYouMessage').style.display = 'block';
          setTimeout(() => {
            document.getElementById('thankYouMessage').style.display = 'none';
          }, 3000);

          toggleFormVisibility();
          
        } else {
          throw new Error(result.message);
        }
        
      } catch (error) {
        console.error('Error:', error);
        showNotification('Gagal menyimpan data: ' + error.message, 'error');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    });

    // Event listener untuk form tambah user
    document.getElementById('addUserForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      addUser();
    });

    // Event listener untuk form edit user
    document.getElementById('editUserForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      updateUser();
    });

    // Event listener untuk form edit business
    document.getElementById('editForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      updateBusiness();
    });
  </script>
</body>
</html>